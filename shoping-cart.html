<!DOCTYPE html>
<html>
<head>
  <!-- set the encoding of your site -->
  <meta charset="utf-8">
  <!-- set the viewport width and initial-scale on mobile devices -->
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>KAAFI | Cart</title>
  <!-- include the site stylesheet -->
  <link href='https://fonts.googleapis.com/css?family=Montserrat:400,700' rel='stylesheet' type='text/css'>
  <link href='https://fonts.googleapis.com/css?family=Open+Sans:700' rel='stylesheet' type='text/css'>
  <!-- include the site stylesheet -->
  <link rel="stylesheet" href="css/bootstrap.css">
  <!-- include the site stylesheet -->
  <link rel="stylesheet" href="css/fonts.css">
  <!-- include the site stylesheet -->
  <link rel="stylesheet" href="style.css">
  <!-- include the site stylesheet -->
  <link rel="stylesheet" href="css/animate.css">
  <!-- include the site stylesheet -->
  <link rel="stylesheet" href="css/color/color.css">
  <script src="https://cdn.jsdelivr.net/npm/jwt-decode@3.1.2/build/jwt-decode.min.js"></script>
</head>
<body>
  <!-- Page Loader -->
  <div id="pre-loader" class="loader-container">
    <div class="loader">
      <img src="images/svg/rings.svg" alt="loader">
    </div>
  </div>
  <!-- main container of all the page elements -->
  <div id="wrapper">
    <!-- header of the page -->
    <header id="header" class="sticky-header">
      <div class="container">
        <div class="row">
          <div class="col-xs-12">
            <!-- logo of the page -->
            <div class="logo">
              <a href="index.html"><img src="images/kaafi-logo.png" alt="KAAFI"></a>
            </div>
            <div class="nav-holder">
              <a href="#" class="nav-opener"><span>menu</span></a>
              <!-- nav of the page -->
              <nav id="nav">
                <ul class="list-unstyled">
                  <li>
                    <a href="#">home</a>
                    <ul class="list-unstyled drop">
                      <li><a href="index.html">Home 1</a></li>
                      <li><a href="home.html">Home 2</a></li>
                    </ul>
                  </li>
                  <li class="mega-drop active">
                    <a href="#">shop</a>
                    <div class="drop-holder">
                      <div class="coll">
                        <strong class="title">SHOP PAGE</strong>
                        <ul class="list-unstyled">
                          <li><a href="category-page.html">Shop</a></li>
                          <li><a href="shoping-cart.html">Shoping Cart</a></li>
                          <li><a href="shoping-cart.html">Checkout</a></li>
                          <li><a href="login.html">Wishlist</a></li>
                          <li><a href="login.html">Login</a></li>
                        </ul>
                      </div>
                      <div class="coll">
                        <strong class="title">PRODUCTS</strong>
                        <ul class="list-unstyled">
                          <li><a href="#">Basic Products</a></li>
                          <li><a href="#">Simple Products</a></li>
                          <li><a href="#">Varieble Products</a></li>
                          <li><a href="#">Simple Products</a></li>
                        </ul>
                      </div>
                      <div class="coll coll-2">
                        <strong class="title">LAST CHANCE</strong>
                        <div class="offer-txt">
                          <span class="txt">sale</span>
                          <span class="offer-sale">40%</span>
                          <span class="txt-about">Pharetra, erat sed <br>fermentum feugiat, velit <br>mauris egestas quam. </span>
                          <a href="#" class="btn-more">Read more <i class="icon-right-arrow"></i></a>
                          <div class="img-holder">
                            <img src="http://placehold.it/150x100" alt="image description">
                          </div>
                        </div>
                      </div>
                    </div>
                  </li>
                  <li>
                    <a href="#">blog</a>
                    <ul class="list-unstyled drop">
                      <li><a href="blog.html">Blog</a></li>
                      <li><a href="blog-detail.html">Single Post</a></li>
                    </ul>
                  </li>
                  <li><a href="about-us.html">about</a></li>
                  <li><a href="contact-us.html">Contact</a></li>
                </ul>
              </nav>
              <div class="align-right">
                <!-- social-networks of the page -->
                <ul class="list-unstyled icon-list">
                  <li>
                    <a href="register.html"><img src="images/user.png" alt="images description"></a>
                  </li>
                  <li class="cart-box hidden-xs">
                    <a class="cart-opener opener-icons" href="#">
                      <i class="icon-cart"></i>
                      <span class="cart-num">2</span>
                    </a>
                    <div class="cart-drop">
                      <div class="cart-holder">
                        <strong class="main-title">You have <i>4 items</i> in your card</strong>
                        <ul class="cart-list list-unstyled">
                          <li>
                            <div class="image">
                              <a href="#"><img alt="Image Description" src="images/img02.jpg"></a>
                            </div>
                            <div class="description">
                              <span class="product-name"><a href="#">Kenneth Jay Lane</a></span>
                              <span class="price">₹230</span>
                            </div>
                            <a class="icon-close" href="#"></a>
                          </li>
                          <li>
                            <div class="image">
                              <a href="#"><img alt="Image Description" src="images/img02.jpg"></a>
                            </div>
                            <div class="description">
                              <span class="product-name"><a href="#">Lavin lady</a></span>
                              <span class="price">₹173</span>
                            </div>
                            <a class="icon-close" href="#"></a>
                          </li>
                        </ul>
                        <div class="total-price-area">
                          <span class="title-text">Total</span>
                          <span class="price">₹403</span>
                        </div>
                        <span class="cart">View card</span>
                        <a href="#" class="btn">checkout</a>
                      </div>
                    </div>
                  </li>
                  <li>
                    <a class="btn-search" href="#"><i class="icon-search"></i></a>
                  </li>
                </ul>
              </div>
            </div>
          </div>
        </div>
      </div>
    </header>
    <!-- Search Popup of the page -->
    <div class="search-popup">
      <div class="holder">
        <div class="col">
          <div class="block-holder">
            <a href="#" class="close-btn"><i class="icon-close"></i></a>
            <form action="#" class="submit-form">
              <fieldset>
                <label for="search" class="icon-search"></label>
                <input type="search" id="search">
              </fieldset>
            </form>
          </div>
        </div>
      </div>
    </div>
    <!-- contain main informative part of the site -->
    <main id="main" role="main">
      <!-- main-banner of the page -->
      <section class="banner" style="background-image: url(http://placehold.it/1920x1000);">
        <span class="sale-percent">SALE OF 50%</span>
        <div class="container">
          <div class="row">
            <div class="col-xs-12">
                <div class="caption">
                  <h1 class="main-heading heading-2">shopping carT</h1>
                  <ul class="list-unstyled breadcrumbs">
                    <li><a href="home.html">Home</a></li>
                    <li><a href="category-page.html">Shop</a></li>
                    <li>Contact</li>
                  </ul>
                </div>
            </div>
          </div>
        </div>
        <span class="year">TRENDS FOR 2016</span>
      </section>
      <!-- shoping-cat-detail of the page -->
      <section class="shoping-cat-detail">
        <div class="container">
          <div class="row wow fadeInUp" data-wow-delay="0.4s">
            <div class="col-xs-12 col-sm-2">
              <span class="title">item</span>
            </div>
            <div class="col-xs-12 col-sm-3">
              <span class="title">dEtail</span>
            </div>
            <div class="col-xs-12 col-sm-2">
              <span class="title">price</span>
            </div>
            <div class="col-xs-12 col-sm-3">
              <span class="title">quantily</span>
            </div>
            <div class="col-xs-12 col-sm-2">
              <span class="title">total</span>
            </div>
          </div>
          <hr>
          <!-- <div id="cart-items" class="product-container"></div> -->
   
    <div id="cart-items"  class="product-container row wow fadeInUp"  data-wow-delay="0.4s">
    
      <hr>
    </div>
         
          <div class="row total-pay wow fadeInUp" data-wow-delay="0.4s">
            <div class="col-xs-12 col-sm-7">
              <strong class="title">coupon</strong>
              <!-- <form action="#" class="form">
                <fieldset>
                  <input type="text" placeholder="Enter promotion code here" class="form-control">
                  <button type="submit" class="btn">apply</button>
                </fieldset>
              </form> -->
              <a href="#" class="btn-more">Continue <i class="icon-right-arrow"></i></a>
            </div>
            <div class="col-xs-12 col-sm-5">
              <div class="total-amunt">
                <div class="holder">
                  <strong class="heading">Subtotal</strong>
                  <span class="price" id="total-price">₹0.00</span>
                </div>
                <div class="holder">
                  <strong class="heading">Tax</strong>
                  <span class="price">₹13</span>
                </div>
                <div class="holder">
                  <strong class="heading">total</strong>
                  <span class="price">₹390</span>
                </div>
                <a href="#" class="btn-primary">process to chectout</a>
              </div>
            </div>
          </div>
        </div>
      </section>
    </main>
    <!-- footer of the Page -->
    <footer id="footer" class="wow fadeInUp" data-wow-delay="0.4s">
      <span class="free-ship">FREE SHIPPING</span>
      <div class="container">
        <div class="row">
          <div class="col-xs-12 col-sm-4 col-lg-4 txt-holder">
            <div class="footer-logo">
              <a href="index.html">jewelry</a>
            </div>
            <p>Pharetra, erat sed fermentum<br> feugiat, velit mauris egestas<br> quam. </p>
          </div>
          <div class="col-xs-12 col-sm-4 col-lg-3">
            <h3>contact us</h3>
            <!-- Contact of the page -->
            <ul class="list-unstyled contact-info">
              <li><i class="icon icon-location"></i><address>Limited. 222-UTC , EU .</address></li>
              <li><i class="icon icon-email"></i><a class="txt" href="#">upport@emtheme.com</a></li>
              <li><i class="icon icon-phone"></i><a class="txt" href="#">(00)-213 1234567</a></li>
              <li><i class="icon icon-printer"></i><a class="txt" href="#">(00)-213 1879017</a></li>
            </ul>
          </div>
          <div class="col-xs-12 col-sm-4 col-lg-5">
            <h3>intagram feed</h3>
            <!-- Instagram of the page -->
            <ul class="list-unstyled instagram-list">
              <li><a href="#"><img src="http://placehold.it/95x70" alt="image description"></a></li>
              <li><a href="#"><img src="http://placehold.it/95x70" alt="image description"></a></li>
              <li><a href="#"><img src="http://placehold.it/95x70" alt="image description"></a></li>
              <li><a href="#"><img src="http://placehold.it/95x70" alt="image description"></a></li>
              <li><a href="#"><img src="http://placehold.it/95x70" alt="image description"></a></li>
              <li><a href="#"><img src="http://placehold.it/95x70" alt="image description"></a></li>
              <li><a href="#"><img src="http://placehold.it/95x70" alt="image description"></a></li>
              <li><a href="#"><img src="http://placehold.it/95x70" alt="image description"></a></li>
            </ul>
          </div>
        </div>
      </div>
      <span class="support">24H SUPPORT</span>
    </footer>
    <!-- Back Top of the page -->
    <span id="back-top" class="arrow_carrot-up"></span>
  </div>
<!-- cart script -->
<script>
  async function fetchUserCart() {
      try {
          const accessToken = localStorage.getItem('access_token');

          if (!accessToken) {
              throw new Error('Access token not found.');
          }

          const userId = jwt_decode(accessToken).id;
          const cartUrl = `http://localhost:5000/api/carts/find/${userId}`;
          const response = await fetch(cartUrl, {
              headers: {
                  Authorization: `Bearer ${accessToken}`,
              },
          });

          if (!response.ok) {
              throw new Error('Network response was not OK');
          }

          const cartData = await response.json();
          displayUserCart(cartData);
      } catch (error) {
          handleFetchError('user cart', error);
      }
  }
  
  async function fetchProductDetails(productId) {
      try {
          const productUrl = `http://localhost:5000/api/products/find/${productId}`;
          const response = await fetch(productUrl);

          if (!response.ok) {
              throw new Error('Network response was not OK');
          }

          const productData = await response.json();
          productData.productId = productId;
          return productData;
      } catch (error) {
          handleFetchError('product', error);
          return null;
      }
  }


function createProductCard(product, quantity) {
const productCard = document.createElement('div');
productCard.classList.add('product-card');
productCard.setAttribute('data-product-id', product.productId); 
productCard.innerHTML = `
<div class="detail-holder">
        <div class="col-xs-12 col-sm-2">
          <div class="img-holder">
            <img src="${product.img}" alt="image descripton"> </br>
            <button data-product-id="${product.productId}" class="increase-button"> + </button>
        <button data-product-id="${product.productId}" class="decrease-button"> - </button>
        <button data-product-id="${product.productId}" class="delete-button">Delete</button>
          </div>

        </div>
        <div class="col-xs-12 col-sm-3">
          <span class="txt">${product.title}</span> </br>
          <span class="txt">Description: ${product.desc}</span>
        </div>
        <div class="col-xs-12 col-sm-2">
          <span class="txt">₹${product.price}</span>
        </div>
        <div class="col-xs-12 col-sm-3">
          <span class="qynt" id="quantity-${product.productId}" data-product-id="${product.productId}">${quantity}</span>
         
        </div>
        <div class="col-xs-12 col-sm-2">
          <span class="txt" id="perticulartotal-${product.productId}" data-product-id="${product.productId}">${(product.price * quantity).toFixed(2)}</span>
       
        </div>
      
     
      </div>
    </hr>
`;

return productCard;
}



async function displayUserCart(cartData) {
const cartItemsContainer = document.getElementById('cart-items');
cartItemsContainer.innerHTML = '';

let totalPrice = 0; // Initialize the total price

if (!cartData || !cartData.products || cartData.products.length === 0) {
  cartItemsContainer.innerHTML = '<p>Your cart is empty.</p>';
} else {
  for (const cartItem of cartData.products) {
      if (cartItem.productId && cartItem.productId !== 'undefined') {
          console.log('Fetching product details for productId:', cartItem.productId);
          const productData = await fetchProductDetails(cartItem.productId);
          if (productData) {
              const productCard = createProductCard(productData, cartItem.quantity);
              cartItemsContainer.appendChild(productCard);

              // Calculate and update the total price for this product
              totalPrice += productData.price * cartItem.quantity;
          }
      }
  }

  // Display the total price in the HTML element
  const totalPriceElement = document.getElementById('total-price');
  if (totalPriceElement) {
      totalPriceElement.textContent = `₹${totalPrice.toFixed(2)}`;
  }

  cartItemsContainer.addEventListener('click', async (event) => {
if (event.target && event.target.matches('button[data-product-id]')) {
   const productId = event.target.dataset.productId;
   if (event.target.classList.contains('increase-button')) {
      increaseQuantity(event);
   } else if (event.target.classList.contains('decrease-button')) {
       decreaseQuantity(event);
   } else if (event.target.classList.contains('delete-button')) {
       await deleteProductFromCart(productId);
   }
}
});
}
}




  function handleFetchError(type, error) {
      console.error(`Error fetching ${type}:`, error);
      // Handle the error as needed, e.g., display an error message to the user.
  }

  // Call the function to fetch and display the user's cart
  fetchUserCart();

  async function increaseQuantity(event) {
  const buttonElement = event.target;

  if (buttonElement && buttonElement.dataset && buttonElement.dataset.productId) {
    const productId = buttonElement.dataset.productId;

    try {
      // Fetch product details to get the available quantity
      const productData = await fetchProductDetails(productId);

      if (productData) {
        const availableQuantity = productData.quantity; // Assuming the available quantity is present in the product data

        // Check if the current quantity is less than the available quantity
        const currentQuantityElement = document.getElementById(`quantity-${productId}`);
        const currentQuantity = parseInt(currentQuantityElement.textContent);

        if (currentQuantity < availableQuantity) {
          const newQuantity = 1;

          // Update the cart only if there's available quantity
          await updateCart(productId, newQuantity);

          console.log(`Quantity updated to ${newQuantity} for productId: ${productId}`);
        } else {
          console.log('Quantity cannot be increased further. It is already at the maximum available quantity.');
          // You may choose to handle this case differently, e.g., show a message to the user.
        }
      }
    } catch (error) {
      handleFetchError('increase quantity', error);
    }
  } else {
    console.log('Invalid buttonElement or productId.');
  }
}


//   async function increaseQuantity(event) {
// const buttonElement = event.target;

// if (buttonElement && buttonElement.dataset && buttonElement.dataset.productId) {
//   const productId = buttonElement.dataset.productId;

//   try {
    
//       const newQuantity = 1;

//       await updateCart(productId, newQuantity);

//       console.log(`Quantity updated to ${newQuantity} for productId: ${productId}`);
//   } catch (error) {
//       handleFetchError('increase quantity', error);
//   }
// } else {
//   console.log('Invalid buttonElement or productId.');
// }
// }



async function decreaseQuantity(event) {
  const buttonElement = event.target;

  if (buttonElement && buttonElement.dataset && buttonElement.dataset.productId) {
    const productId = buttonElement.dataset.productId;

    try {
      // Check if the current quantity is greater than 1
      const currentQuantityElement = document.getElementById(`quantity-${productId}`);
      const currentQuantity = parseInt(currentQuantityElement.textContent);

      if (currentQuantity > 1) {
        const newQuantity = -1;

        // Update the cart only if the quantity is greater than 1
        await updateCart(productId, newQuantity);

        console.log(`Quantity updated to decrease by 1 for productId: ${productId}`);
      } else {
        console.log('Quantity cannot be decreased further. Remove the item or handle accordingly.');
        // You may choose to handle this case differently, e.g., show a message to the user.
      }
    } catch (error) {
      handleFetchError('decrease quantity', error);
    }
  } else {
    console.log('Invalid buttonElement or productId.');
  }
}



// async function decreaseQuantity(event) {
// const buttonElement = event.target;

// if (buttonElement && buttonElement.dataset && buttonElement.dataset.productId) {
//   const productId = buttonElement.dataset.productId;

//   try {
    
//       const newQuantity = -1;


//       await updateCart(productId, newQuantity);

     
//       console.log(`Quantity updated to decrease by 1 for productId: ${productId}`);
//   } catch (error) {
//       handleFetchError('decrease quantity', error);
//   }
// } else {
//   console.log('Invalid buttonElement or productId.');
// }
// }

 

function updateTotalPrice() {
const productCards = document.querySelectorAll('.product-card');
let total = 0;

productCards.forEach((productCard) => {
  const productId = productCard.getAttribute('data-product-id');
  const quantityElement = productCard.querySelector(`#quantity-${productId}`);
  const priceElement = productCard.querySelector('.product-price');
  const perticulartotalElement = productCard.querySelector(`#perticulartotal-${productId}`);

  if (quantityElement && priceElement && perticulartotalElement) {
      const quantity = parseInt(quantityElement.textContent);
      const price = parseFloat(priceElement.textContent);
      total += quantity * price;

      // Update the total for a particular product
      perticulartotalElement.textContent = (quantity * price).toFixed(2);
  }
});

// Display the updated total price in the HTML element
const totalPriceElement = document.getElementById('total-price');
if (totalPriceElement) {
  totalPriceElement.textContent = `Total Price: $${total.toFixed(2)}`;
}
}


  async function deleteProductFromCart(productId) {
try {
  const accessToken = localStorage.getItem('access_token');

  if (!accessToken) {
      throw new Error('Access token not found.');
  }

  const userId = jwt_decode(accessToken).id;

  const cartUrl = `http://localhost:5000/api/carts/${userId}/${productId}`; // Include productId
  const response = await fetch(cartUrl, {
      method: 'DELETE',
      headers: {
          'Authorization': `Bearer ${accessToken}`,
      },
  });

  if (!response.ok) {
      throw new Error('Network response was not OK');
  }

  // Remove the product card from the user interface
  const productCard = document.querySelector(`.product-card[data-product-id="${productId}"]`);
  if (productCard) {
      productCard.remove();
  }
  location.reload();
  // You can handle the updated cart data as needed.
} catch (error) {
  handleFetchError('delete product', error);
}
}


async function updateCart(productId, newQuantity) {
try {
  const accessToken = localStorage.getItem('access_token');

  if (!accessToken) {
      throw new Error('Access token not found.');
  }

  const userId = jwt_decode(accessToken).id;
  const cartUrl = `http://localhost:5000/api/carts/${userId}`;
  const response = await fetch(cartUrl, {
      method: 'PUT',
      headers: {
          'Authorization': `Bearer ${accessToken}`,
          'Content-Type': 'application/json',
      },
      body: JSON.stringify({ productId, quantity: newQuantity }),
  });

  if (!response.ok) {
      throw new Error('Network response was not OK');
  }

  const updatedCartData = await response.json();
  // You can handle the updated cart data as needed.

  location.reload();

} catch (error) {
  handleFetchError('update cart', error);
}
}


</script>

  <!-- include jQuery -->
  <script src="js/jquery-1.11.3.min.js"></script>
  <!-- include jQuery -->
  <script src="js/plugins.js"></script>
  <!-- include jQuery -->
  <script src="js/jquery.main.js"></script>
</body>
</html>